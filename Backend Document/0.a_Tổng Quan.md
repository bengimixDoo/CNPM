# T√ÄI LI·ªÜU K·ª∏ THU·∫¨T: H·ªÜ TH·ªêNG QU·∫¢N L√ù CHUNG C∆Ø (AMS)

Phi√™n b·∫£n: 1.0
C√¥ng ngh·ªá: Backend Django (Python), Database PostgreSQL (Neon), Django REST Framework (DRF).
Ki·∫øn tr√∫c: Monolithic Modular.

---

## 1. T·ªîNG QUAN H·ªÜ TH·ªêNG (SYSTEM OVERVIEW)

H·ªá th·ªëng ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ qu·∫£n l√Ω to√†n di·ªán quy tr√¨nh v·∫≠n h√†nh c·ªßa m·ªôt chung c∆∞, bao g·ªìm: Qu·∫£n l√Ω c∆∞ d√¢n, t√≠nh to√°n h√≥a ƒë∆°n ƒëi·ªán n∆∞·ªõc t·ª± ƒë·ªông, qu·∫£n l√Ω t√†i ch√≠nh v√† h·ªó tr·ª£ c∆∞ d√¢n.

### C·∫•u tr√∫c Project (Django Apps)

H·ªá th·ªëng ƒë∆∞·ª£c chia th√†nh 4 Modules (Apps) ch√≠nh:

|**App Name**|**Th∆∞ m·ª•c**|**Ch·ª©c nƒÉng ch√≠nh**|
|---|---|---|
|**Identity**|`users`|Qu·∫£n l√Ω x√°c th·ª±c, ph√¢n quy·ªÅn (Auth & RBAC).|
|**Core**|`residents`|Qu·∫£n l√Ω d·ªØ li·ªáu g·ªëc: CƒÉn h·ªô, C∆∞ d√¢n, Bi·∫øn ƒë·ªông nh√¢n kh·∫©u.|
|**Finance**|`finance`|Qu·∫£n l√Ω gi√° ph√≠, ch·ªâ s·ªë ƒëi·ªán n∆∞·ªõc, h√≥a ƒë∆°n, doanh thu.|
|**Services**|`services`|Ti·ªán √≠ch: G·ª≠i xe, Tin t·ª©c, Y√™u c·∫ßu h·ªó tr·ª£ (Tickets).|
## 2. THI·∫æT K·∫æ C∆† S·ªû D·ªÆ LI·ªÜU (DATABASE SCHEMA)

### 2.1. App `users`

_Ch·ªãu tr√°ch nhi·ªám ƒë·ªãnh danh ng∆∞·ªùi d√πng._

- **Table `Users`**
    
    - `id`: PK, Auto Increment.
        
    - `username`, `password`: Credentials.
        
    - `role`: `['ADMIN', 'QUAN_LY', 'CU_DAN']`. X√°c ƒë·ªãnh quy·ªÅn h·∫°n.
        
    - `cu_dan_id`: FK (nullable). Li√™n k·∫øt 1-1 v·ªõi h·ªì s∆° c∆∞ d√¢n th·ª±c t·∫ø (n·∫øu role l√† CU_DAN).
        
    - `is_active`: Boolean. D√πng ƒë·ªÉ kh√≥a t√†i kho·∫£n (Soft delete).

### 2.2. App `residents`

_Ch·ªãu tr√°ch nhi·ªám qu·∫£n l√Ω t√†i s·∫£n v√† con ng∆∞·ªùi._

- **Table `CanHo` (Apartment)**
    
    - `MaCanHo`: PK. ID n·ªôi b·ªô h·ªá th·ªëng.
        
    - `MaHienThi`: Unique (VD: A-101). M√£ ph√≤ng hi·ªÉn th·ªã cho user.
        
    - `MaChuSoHuu`: FK -> `CuDan`. Ng∆∞·ªùi ƒë·ª©ng t√™n ph√°p l√Ω.
        
    - `TrangThai`: `['Trong', 'DaBan', 'ChoThue']`.

- **Table `CuDan` (Resident Profile)**
    
    - `MaCuDan`: PK. H·ªì s∆° g·ªëc c·ªßa m·ªôt c√¥ng d√¢n.
        
    - `MaCanHoDangO`: FK -> `CanHo`. X√°c ƒë·ªãnh th·ª±c t·∫ø ng∆∞·ªùi n√†y ƒëang ·ªü ƒë√¢u.
        
    - `LaChuHo`: Boolean. Ng∆∞·ªùi ƒë·∫°i di·ªán nh·∫≠n th√¥ng b√°o.
        
    - `TrangThaiCuTru`: `['ThuongTru', 'TamTru']`.

- **Table `BienDongDanCu` (Resident History)**
    
    - `MaBienDong`: PK.
        
    - `LoaiBienDong`: `['NhapKhau', 'ChuyenDi', 'TamVang']`.
        
    - `NgayThucHien`: Th·ªùi ƒëi·ªÉm bi·∫øn ƒë·ªông.
        
    - _M·ª•c ƒë√≠ch:_ L∆∞u l·ªãch s·ª≠ ƒë·ªÉ truy xu·∫•t b√°o c√°o c∆∞ tr√∫.

### 2.3. App `finance`

_Ch·ªãu tr√°ch nhi·ªám v·ªÅ d√≤ng ti·ªÅn._

- **Table `DanhMucPhi` (Fee Categories)**
    
    - `MaLoaiPhi`: PK.
        
    - `TenLoaiPhi`: (VD: ƒêi·ªán, N∆∞·ªõc, Ph√≠ QL).
        
    - `DonGiaHienTai`: Gi√° hi·ªán h√†nh.

- **Table `ChiSoDienNuoc` (Utility Readings)**
    
    - `MaChiSo`: PK.
        
    - `ChiSoCu`, `ChiSoMoi`: S·ªë li·ªáu ch·ªët h√†ng th√°ng.
        
    - `NgayChot`: Ng√†y ghi nh·∫≠n.

- **Table `HoaDon` (Invoice Header)**
    
    - `MaHoaDon`: PK.
        
    - `TongTien`: T·ªïng gi√° tr·ªã h√≥a ƒë∆°n.
        
    - `TrangThai`: `[0: Unpaid, 1: Paid]`.

- **Table `ChiTietHoaDon` (Invoice Items)**
    
    - `MaChiTiet`: PK.
        
    - `MaHoaDon`: FK.
        
    - `DonGiaSnapshot`: **Quan tr·ªçng.** L∆∞u c·ª©ng gi√° t·∫°i th·ªùi ƒëi·ªÉm t·∫°o h√≥a ƒë∆°n (tr√°nh sai l·ªách khi gi√° g·ªëc thay ƒë·ªïi).
        
    - `ThanhTien`: `SoLuong * DonGiaSnapshot`.

### 2.4. App `services`

- **Table `PhuongTien`**: Qu·∫£n l√Ω xe ra v√†o.
    
- **Table `YeuCau`**: Ticket h·ªó tr·ª£ (B√°o h·ªèng, khi·∫øu n·∫°i).
    
- **Table `TinTuc`**: H·ªá th·ªëng th√¥ng b√°o n·ªôi b·ªô.

---
## 3. LU·ªíNG D·ªÆ LI·ªÜU & NGHI·ªÜP V·ª§ (DATA FLOW)

### 3.1. Quy tr√¨nh Ch·ªët ph√≠ & T·∫°o h√≥a ƒë∆°n (Billing Cycle)

1. **Input:** Ban qu·∫£n l√Ω (BQL) nh·∫≠p ch·ªâ s·ªë ƒëi·ªán n∆∞·ªõc v√†o b·∫£ng `ChiSoDienNuoc` (ho·∫∑c import Excel).
    
2. **Trigger:** BQL g·ªçi API "T·∫°o h√≥a ƒë∆°n th√°ng X".
    
3. **Processing (Transaction Atomic):**
    
    - H·ªá th·ªëng qu√©t t·∫•t c·∫£ CƒÉn h·ªô ƒëang c√≥ ng∆∞·ªùi ·ªü.
        
    - T√≠nh ti·ªÅn ƒëi·ªán/n∆∞·ªõc: `(M·ªõi - C≈©) * Gi√° (DanhMucPhi)`.
        
    - T√≠nh ph√≠ qu·∫£n l√Ω: `Di·ªán t√≠ch * Gi√°`.
        
    - T√≠nh ph√≠ g·ª≠i xe: `S·ªë l∆∞·ª£ng xe * Gi√°`.
        
    - **L∆∞u Snapshot:** Ghi c√°c d√≤ng t√≠nh to√°n v√†o `ChiTietHoaDon` v·ªõi gi√° t·∫°i th·ªùi ƒëi·ªÉm ƒë√≥.
        
    - C·∫≠p nh·∫≠t t·ªïng ti·ªÅn v√†o `HoaDon`.
        
4. **Output:** C∆∞ d√¢n nh·∫≠n th√¥ng b√°o, th·∫•y h√≥a ƒë∆°n tr√™n App.
    

### 3.2. Quy tr√¨nh C∆∞ d√¢n chuy·ªÉn ƒë·∫øn (Move-in)

1. **Input:** BQL t·∫°o h·ªì s∆° `CuDan`.
    
2. **Action:** BQL th·ª±c hi·ªán l·ªánh "Move-in" v√†o cƒÉn h·ªô A-101.
    
3. **Processing:**
    
    - Update `CuDan.MaCanHoDangO = A-101`.
        
    - Insert `BienDongDanCu` (Lo·∫°i: Nh·∫≠p kh·∫©u).
        
    - (Optional) T·∫°o t√†i kho·∫£n `Users` v√† link v·ªõi `CuDan`.

---

## 4. ƒê·∫∂C T·∫¢ API (API SPECIFICATION)

Base URL: `/api/v1/`
### 4.1. Module Auth (`users`)

|**Method**|**Endpoint**|**Quy·ªÅn**|**M√¥ t·∫£**|
|---|---|---|---|
|`POST`|`/auth/token/`|Public|Login (L·∫•y JWT Token).|
|`POST`|`/auth/token/refresh/`|Public|Refresh Token.|
|`GET`|`/users/me/`|Auth|L·∫•y th√¥ng tin user & profile c∆∞ d√¢n.|
|`POST`|`/users/change-password/`|Auth|ƒê·ªïi m·∫≠t kh·∫©u.|

### 4.2. Module Residents (`residents`)

|**Method**|**Endpoint**|**Quy·ªÅn**|**M√¥ t·∫£**|
|---|---|---|---|
|`GET`|`/apartments/`|Auth|Danh s√°ch cƒÉn h·ªô.|
|`GET`|`/apartments/{id}/`|Auth|Chi ti·∫øt cƒÉn h·ªô (k√®m danh s√°ch ng∆∞·ªùi ·ªü).|
|`GET`|`/residents/`|Manager|Danh s√°ch to√†n b·ªô c∆∞ d√¢n.|
|`POST`|`/residents/`|Manager|T·∫°o h·ªì s∆° c∆∞ d√¢n m·ªõi.|
|`POST`|`/residents/{id}/move-in/`|Manager|C∆∞ d√¢n nh·∫≠p kh·∫©u v√†o cƒÉn h·ªô.|
|`POST`|`/residents/{id}/move-out/`|Manager|C∆∞ d√¢n chuy·ªÉn ƒëi.|

### 4.3. Module Finance (`finance`)

|**Method**|**Endpoint**|**Quy·ªÅn**|**M√¥ t·∫£**|
|---|---|---|---|
|`GET`|`/fee-categories/`|Auth|Xem b·∫£ng gi√° d·ªãch v·ª•.|
|`POST`|`/utility-readings/batch/`|Manager|Nh·∫≠p ch·ªâ s·ªë ƒëi·ªán n∆∞·ªõc h√†ng lo·∫°t.|
|`POST`|`/invoices/batch-generate/`|Manager|**T·∫°o h√≥a ƒë∆°n th√°ng (Batch Job).**|
|`GET`|`/invoices/`|Auth|Xem danh s√°ch h√≥a ƒë∆°n.|
|`GET`|`/invoices/{id}/`|Auth|Xem chi ti·∫øt h√≥a ƒë∆°n (Items).|
|`POST`|`/invoices/{id}/confirm-payment/`|Manager|X√°c nh·∫≠n h√≥a ƒë∆°n ƒë√£ thanh to√°n.|

### 4.4. Module Services (`services`)

|**Method**|**Endpoint**|**Quy·ªÅn**|**M√¥ t·∫£**|
|---|---|---|---|
|`GET`|`/vehicles/`|Auth|Danh s√°ch ph∆∞∆°ng ti·ªán.|
|`GET`|`/support-tickets/`|Auth|Danh s√°ch y√™u c·∫ßu h·ªó tr·ª£.|
|`POST`|`/support-tickets/`|Resident|G·ª≠i y√™u c·∫ßu m·ªõi.|
|`PATCH`|`/support-tickets/{id}/`|Manager|C·∫≠p nh·∫≠t tr·∫°ng th√°i/Ph·∫£n h·ªìi y√™u c·∫ßu.|
|`GET`|`/news/`|Public|Xem tin t·ª©c.|

--- 
## 5. PH√ÇN QUY·ªÄN & B·∫¢O M·∫¨T (SECURITY & PERMISSIONS)

H·ªá th·ªëng s·ª≠ d·ª•ng c∆° ch·∫ø **Role-Based Access Control (RBAC)** k·∫øt h·ª£p **Object-Level Permission**.

### 5.1. ƒê·ªãnh nghƒ©a Roles

1. **ADMIN:** Qu·∫£n tr·ªã vi√™n h·ªá th·ªëng (To√†n quy·ªÅn, qu·∫£n l√Ω Users, C·∫•u h√¨nh ph√≠).
    
2. **MANAGER (Ban Qu·∫£n L√Ω):** V·∫≠n h√†nh h√†ng ng√†y (Nh·∫≠p li·ªáu, T·∫°o h√≥a ƒë∆°n, Duy·ªát y√™u c·∫ßu).
    
3. **RESIDENT (C∆∞ D√¢n):** Ng∆∞·ªùi d√πng cu·ªëi (Xem th√¥ng tin c√° nh√¢n, H√≥a ƒë∆°n, G·ª≠i y√™u c·∫ßu).

### 5.2. Permission Matrix (Ma tr·∫≠n quy·ªÅn h·∫°n)

| **Ch·ª©c nƒÉng (Feature)**           | **ADMIN** | **MANAGER** | **RESIDENT** | **Ghi ch√∫**                       |
| --------------------------------- | --------- | ----------- | ------------ | --------------------------------- |
| **User Mgmt** (T·∫°o/S·ª≠a User)      | ‚úÖ         | ‚ùå           | ‚ùå            | Ch·ªâ Admin ƒë∆∞·ª£c qu·∫£n l√Ω t√†i kho·∫£n. |
| **Config Fees** (S·ª≠a gi√°)         | ‚úÖ         | ‚ùå           | üëÄ Read      | Tr√°nh BQL s·ª≠a gi√° t√πy ti·ªán.       |
| **Residents** (Xem DS C∆∞ d√¢n)     | ‚úÖ         | ‚úÖ           | ‚ùå            | B·∫£o m·∫≠t th√¥ng tin h√†ng x√≥m.       |
| **Move In/Out** (Nh·∫≠p kh·∫©u)       | ‚úÖ         | ‚úÖ           | ‚ùå            | Nghi·ªáp v·ª• c·ªßa BQL.                |
| **Utility Data** (Nh·∫≠p ƒëi·ªán/n∆∞·ªõc) | ‚ùå         | ‚úÖ           | ‚ùå            |                                   |
| **Billing** (T·∫°o h√≥a ƒë∆°n)         | ‚ùå         | ‚úÖ           | ‚ùå            | BQL ch·ªët s·ªï cu·ªëi th√°ng.           |
| **Invoices** (Xem h√≥a ƒë∆°n)        | ‚úÖ         | ‚úÖ           | ‚úÖ (Own)      | C∆∞ d√¢n ch·ªâ xem h√≥a ƒë∆°n c·ªßa m√¨nh.  |
| **Payment** (X√°c nh·∫≠n thu ti·ªÅn)   | ‚ùå         | ‚úÖ           | ‚ùå            |                                   |
| **Ticket** (G·ª≠i y√™u c·∫ßu)          | ‚ùå         | ‚ùå           | ‚úÖ            |                                   |
| **Ticket** (X·ª≠ l√Ω y√™u c·∫ßu)        | ‚úÖ         | ‚úÖ           | ‚ùå            |                                   |

---

## 6. TECHNICAL NOTES (L∆ØU √ù K·ª∏ THU·∫¨T)

1. **Snapshot Pricing:** Khi code logic t·∫°o h√≥a ƒë∆°n (`finance.services.InvoiceGenerator`), b·∫Øt bu·ªôc ph·∫£i copy gi√° t·ª´ `DanhMucPhi` sang `ChiTietHoaDon`. Tuy·ªát ƒë·ªëi kh√¥ng query ng∆∞·ª£c l·∫°i b·∫£ng gi√° khi hi·ªÉn th·ªã h√≥a ƒë∆°n l·ªãch s·ª≠.
    
2. **Atomic Transactions:** C√°c API ghi d·ªØ li·ªáu ph·ª©c t·∫°p (`batch-generate`, `move-in`) ph·∫£i b·ªçc trong block `transaction.atomic()` ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu.
    
3. **Timezone:** C·∫•u h√¨nh Django s·ª≠ d·ª•ng `Asia/Ho_Chi_Minh`. T·∫•t c·∫£ `datetime` l∆∞u trong DB n√™n l√† UTC, convert sang Local Time ·ªü t·∫ßng View/Serializer.